from kortex_api.autogen.client_stubs.BaseClientRpc import BaseClient
from kortex_api.autogen.messages import Base_pb2


class GripperOpen:
    """
    Open the Kinova Gen3 gripper using speed commands.
    """

    def __init__(self, router, speed=0.1):
        self.base = BaseClient(router)
        self.speed = speed

    def execute(self):
        gripper_command = Base_pb2.GripperCommand()
        finger = gripper_command.gripper.finger.add()

        print("Opening gripper using speed command...")
        gripper_command.mode = Base_pb2.GRIPPER_SPEED
        finger.value = self.speed
        self.base.SendGripperCommand(gripper_command)

        gripper_request = Base_pb2.GripperRequest()
        gripper_request.mode = Base_pb2.GRIPPER_POSITION

        while True:
            gripper_measure = self.base.GetMeasuredGripperMovement(gripper_request)
            if len(gripper_measure.finger):
                print(f"Current position: {gripper_measure.finger[0].value:.3f}")
                if gripper_measure.finger[0].value < 0.01:
                    break
            else:
                break


class GripperClose:
    """
    Close the Kinova Gen3 gripper using speed commands.
    """

    def __init__(self, router, speed=-0.1, target_position=0.32):
        self.base = BaseClient(router)
        self.speed = speed
        self.target_position = target_position

    def execute(self):
        gripper_command = Base_pb2.GripperCommand()
        finger = gripper_command.gripper.finger.add()

        print("Closing gripper using speed command...")
        gripper_command.mode = Base_pb2.GRIPPER_SPEED
        finger.value = self.speed
        self.base.SendGripperCommand(gripper_command)

        gripper_request = Base_pb2.GripperRequest()
        gripper_request.mode = Base_pb2.GRIPPER_POSITION

        while True:
            gripper_measure = self.base.GetMeasuredGripperMovement(gripper_request)
            if len(gripper_measure.finger):
                pos = gripper_measure.finger[0].value
                print(f"Current position: {pos:.3f}")
                if pos >= self.target_position:
                    break
            else:
                break
